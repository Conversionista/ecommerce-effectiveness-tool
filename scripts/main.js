"use strict";function addProgress(e){progress+=e,$("body").loadie(progress)}function finishProgress(){progress=1,$("body").loadie(progress)}function apiResponse(e,t,n,a,o,s){$.when(queryShoppingStage(e,t,n,a,o),queryUsers(e,t,n,a,o),queryNonBounce(e,t,n,a,o)).then(function(e,t,n){for(var a=0,o=0;o<e.result.reports[0].data.rows.length;o++){var r=e.result.reports[0].data.rows[o].dimensions[0];jQuery.inArray(r,queryArray)>=0&&(queryObj[r]=e.result.reports[0].data.rows[o].metrics[0].values[0])}queryObj.USERS=0,$.each(t.result.reports[0].data.rows,function(e,t){queryObj.USERS+=Number(t.metrics[0].values[0])}),queryObj.NON_BOUNCE_USERS=0,$.each(n.result.reports[0].data.rows,function(e,t){queryObj.NON_BOUNCE_USERS+=Number(t.metrics[0].values[0])});var i=getPercent(queryObj.NON_BOUNCE_USERS,queryObj.USERS);if(checkIfNaN(i))return!1;var l=[0,50,71];s?(a=getTrend(engagementResult,i),setComparison("engagement",i,a,l),$("#result-table").removeClass("hidden")):(engagementResult=i,setResult("engagement",i,l,queryObj.NON_BOUNCE_USERS));var c=getPercent(queryObj.PRODUCT_VIEW,queryObj.NON_BOUNCE_USERS);if(checkIfNaN(c))return!1;var u=[0,60,81];s?(a=getTrend(findResult,c),setComparison("find",c,a,u)):(findResult=c,setResult("find",c,u,queryObj.PRODUCT_VIEW));var d=getPercent(queryObj.ADD_TO_CART,queryObj.PRODUCT_VIEW);if(checkIfNaN(d))return!1;var p=[0,15,21];s?(a=getTrend(effectivenessResult,d),setComparison("effectiveness",d,a,p)):(effectivenessResult=d,setResult("effectiveness",d,p,queryObj.ADD_TO_CART));var m=getPercent(queryObj.CHECKOUT,queryObj.ADD_TO_CART),g=[0,60,81];s?(a=getTrend(beginCheckoutResult,m),setComparison("begin-checkout",m,a,g)):(beginCheckoutResult=m,setResult("begin-checkout",m,g,queryObj.CHECKOUT));var h=getPercent(queryObj.TRANSACTION,queryObj.CHECKOUT),y=[0,40,61];if(s?(a=getTrend(completeCheckoutResult,h),setComparison("complete-checkout",h,a,y)):(completeCheckoutResult=h,setResult("complete-checkout",h,y,queryObj.TRANSACTION)),$("#canvas").removeClass("hidden"),!s){var f=[["Stay on site",i,setBenchmarkColor(i,l)],["Finding product",c,setBenchmarkColor(c,u)],["Add to cart",d,setBenchmarkColor(d,p)],["Begin checkout",m,setBenchmarkColor(m,g)],["Complete checkout",h,setBenchmarkColor(h,y)]];console.log(f);var b={chart:{width:"100%",height:350,bottomPinch:0,animate:100,curve:{enabled:!0,height:20}},block:{dynamicHeight:!1,highlight:!0,barOverlay:!1,fill:{type:"gradient"}},label:{format:"{f}%"},events:{click:{block:function(e){0===e.index?swal({title:"Stay on site",text:'Engagement rate or opposite of bounce rate. Users who moved on to another page or triggered some kind of event.<br><br><span style="color:green;"><b>Good: 70-100%</b></span><br><span style="color:#c61618;"><b>Bad: 0-50%</b></span>',html:!0}):1===e.index?swal({title:"Find products",text:'Finding rate, or how many users (out of the stay-on-site-users) who visited at least one product page.<br><br><span style="color:green;"><b>Good: 80-100%</b></span><br><span style="color:#c61618;"><b>Bad: 0-60%</b></span>',html:!0}):2===e.index?swal({title:"Add to cart",text:'Your product page effectiveness, or how many users (out of the find-product-users) who added an item to shopping cart.<br><br><span style="color:green;"><b>Good: 20-100%</b></span><br><span style="color:#c61618;"><b>Bad: 0-15%</b></span>',html:!0}):3===e.index?swal({title:"Begin checkout",text:'Checkout rate, or how many users (out of the add-to-cart-users) who visited the checkout page.<br><br><span style="color:green;"><b>Good: 80-100%</b></span><br><span style="color:#c61618;"><b>Bad: 0-50%</b></span>',html:!0}):4===e.index&&swal({title:"Complete checkout",text:'Checkout completion rate, or how many users (out of the begin-checkout-users) who completed the purchase.<br><br><span style="color:green;"><b>Good: 60-100%</b></span><br><span style="color:#c61618;"><b>Bad: 0-40%</b></span>',html:!0})}}}},v=new D3Funnel("#funnel");v.draw(f,b),finishProgress()}})}function queryUsers(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{viewId:e,dateRanges:[{startDate:t,endDate:n}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],dimensions:[{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}]}]}});return i}function queryNonBounce(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:n,startDate:t}],metrics:[{expression:"ga:users"}],samplingLevel:"LARGE",viewId:e,dimensions:[{name:"ga:segment"},{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}],segments:[{dynamicSegment:{name:"segment_name",sessionSegment:{segmentFilters:[{simpleSegment:{orFiltersForSegment:[{segmentFilterClauses:[{metricFilter:{metricName:"ga:bounces",operator:"EQUAL",comparisonValue:"0"}}]}]}}]}}}]}]}});return i}function queryShoppingStage(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:n,startDate:t}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],viewId:e,dimensions:[{name:"ga:shoppingStage"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}]}]}});return i}function getPercent(e,t){var n=Math.round(e/t*100);return n}function getTrend(e,t){var n=Math.round(e-t);return n}function authorize(e){var t=!e,n={client_id:CLIENT_ID,scope:SCOPES,immediate:t};gapi.auth.authorize(n,function(e){var t=document.getElementById("auth-button");e.error?(t.hidden=!1,showAuthDialog()):(t.hidden=!0,console.log("inloggad"),null===ecomFunnel&&$("#modalSettings").modal("show"),queryAccounts())})}function showAuthDialog(){swal({title:"GA Authorization",html:!0,text:"We'll need permission to access your Google Analytics account.<br />",imageUrl:"images/google-analytics-logo.png",confirmButtonText:"Authorize",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),$(".authorize .confirm").click(function(e){$(this).html('<i class="fa fa-cog fa-spin"></i>').attr("disabled",!0),authorize(e)})}function queryAccounts(){gapi.client.load("analytics","v3").then(function(){gapi.client.analytics.management.accounts.list().then(handleAccounts)}),gapi.client.load("plus","v1",function(){var e=gapi.client.plus.people.get({userId:"me"});e.execute(function(e){var t=e.displayName,n=handleEmailResponse(e);sendUserData(t,n),console.log("Retrieved profile for:"+t+", "+n)})})}function handleEmailResponse(e){for(var t,n=0;n<e.emails.length;n++)"account"===e.emails[n].type&&(t=e.emails[n].value);return t}function sendUserData(e,t){"undefined"!=typeof analytics&&(console.log(e+"\n"+t),analytics.identify({name:e,email:t}))}function handleAccounts(e){e.result.items&&e.result.items.length?($("#accountId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===accountId)var n=!0;else n=!1;$("#accountId").append($("<option/>",{value:t.id,text:t.name,selected:n}))}),accountId||(accountId=e.result.items[0].id),queryProperties(accountId)):console.log("No accounts found for this user.")}function queryProperties(e){gapi.client.analytics.management.webproperties.list({accountId:e}).then(handleProperties).then(null,function(e){console.log(e)})}function handleProperties(e){e.result.items&&e.result.items.length?($("#propertyId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){var n=null;n=t.id===propertyId,$("#propertyId").append($("<option/>",{value:t.id,text:t.name,selected:n}))}),propertyId||(propertyId=e.result.items[0].id),queryProfiles(accountId,propertyId)):console.log("No properties found for this user.")}function queryProfiles(e,t){gapi.client.analytics.management.profiles.list({accountId:e,webPropertyId:t}).then(handleProfiles).then(null,function(e){console.log(e)})}function handleProfiles(e){e.result.items&&e.result.items.length?($("#viewId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===viewId){var n=!0;$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1)}else n=!1;$("#viewId").append($("<option/>",{value:t.id,text:t.name,selected:n}))})):console.log("No views (profiles) found for this user.")}function saveLocal(e,t){localStorage.setItem(e,JSON.stringify(t))}function readLocal(e){var t=JSON.parse(localStorage.getItem(e));return t}function updateLocal(e,t,n){var a=readLocal(e);null===a&&(a={}),a[t]=n,saveLocal(e,a)}function setResult(e,t,n,a){var o=setBenchmarkSymbol(t,n);$("#"+e+"-result").addClass("").html(t+"%"+o),$("#"+e+"-users").addClass("").html(a),$("#th-comparison, #th-trend").addClass("hidden"),$("#"+e+"-comparison").removeClass("").addClass("hidden").html(""),$("#"+e+"-trend").removeClass("").addClass("hidden").html("")}function setComparison(e,t,n,a){var o=setBenchmarkSymbol(t,a),s=setTrendSymbol(n);$("#th-comparison, #th-trend").removeClass("hidden"),$("#"+e+"-comparison").removeClass("hidden").addClass("").html(t+"%"+o),$("#"+e+"-trend").removeClass("hidden").addClass("").html(n+"%"+s)}function setBenchmarkColor(e,t){var n=0;$.each(t,function(t,a){e>=a&&(n=t)});var a="";return 0===n?a="#C12107":1===n?a="#F4CD24":2===n&&(a="#65B739"),a}function setBenchmarkSymbol(e,t){var n=0;$.each(t,function(t,a){e>=a&&(n=t)});var a="";return 0===n?a='<span class="text-danger glyphicon glyphicon-exclamation-sign btn-xs" aria-hidden="true"></span>':1===n?a='<span class="text-warning glyphicon glyphicon-eye-open btn-xs" aria-hidden="true"></span>':2===n&&(a='<span class="text-success glyphicon glyphicon-ok btn-xs" aria-hidden="true"></span>'),a}function setTrendSymbol(e){var t="";return 0===e?t='<span class="invisible glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e>0?t='<span class="text-success glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e<0&&(t='<span class="text-danger glyphicon glyphicon-triangle-bottom btn-xs" aria-hidden="true"></span>'),t}function checkIfNaN(e){var t=!1;return isNaN(e)&&(swal({title:"Oops!",html:!0,text:'It seems your website doesn\'t use ecommerce tracking.<br><a href="mailto:martin@conversionista.se">Please contact us for help!</a>',imageUrl:"images/google-analytics-logo.png",confirmButtonText:"OK :(",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),t=!0),t}var ecomFunnel=readLocal("ecomFunnel");if(null!==ecomFunnel)var accountId=ecomFunnel.accountId,propertyId=ecomFunnel.propertyId,viewId=ecomFunnel.viewId;else accountId=!1,propertyId=!1,viewId=!1;$("body").loadie(),$(".loadie").fadeIn();var progress=.2,queryArray=["PRODUCT_VIEW","ADD_TO_CART","CHECKOUT","TRANSACTION"],queryObj={},CLIENT_ID="856128908931-99pe52krvhcn0v81oie89b357gqvgamq.apps.googleusercontent.com",SCOPES=["https://www.googleapis.com/auth/analytics.readonly","https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/plus.profile.emails.read"],startDate=moment().subtract(31,"days").format("YYYY-MM-DD"),endDate=moment().subtract(1,"days").format("YYYY-MM-DD"),deviceCategory="",userType="",engagementResult=0,findResult=0,effectivenessResult=0,beginCheckoutResult=0,completeCheckoutResult=0;$(document).ready(function(){$('input[name="daterange"]').daterangepicker({locale:{format:"YYYY-MM-DD",separator:" – ",applyLabel:"Apply",cancelLabel:"Undo",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"w. ",daysOfWeek:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],firstDay:1},showISOWeekNumbers:!0,applyClass:"btn btn-success",cancelClass:"btn btn-danger",startDate:startDate,endDate:endDate}),$("#date-range").on("apply.daterangepicker",function(e,t){startDate=t.startDate.format("YYYY-MM-DD"),endDate=t.endDate.format("YYYY-MM-DD"),$("#date-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD"))}),$("#comparison-range").on("apply.daterangepicker",function(e,t){var n=t.startDate.format("YYYY-MM-DD"),a=t.endDate.format("YYYY-MM-DD");$("#comparison-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD")),apiResponse(viewId,n,a,deviceCategory,userType,!0)}),$("#date-range").val(startDate+" to "+endDate),$("#comparison-range").val(""),$("#save-settings-btn").on("click",function(e){e.preventDefault(),updateLocal("ecomFunnel","accountId",accountId),updateLocal("ecomFunnel","propertyId",propertyId),updateLocal("ecomFunnel","viewId",viewId)}),$("#get-funnel-btn").on("click",function(e){e.preventDefault(),addProgress(.13),deviceCategory=$('input[name="deviceCategory"]:checked').val(),userType=$('input[name="userType"]:checked').val(),apiResponse(viewId,startDate,endDate,deviceCategory,userType)}),$("#accountId").on("change",function(){accountId=$(this).val(),queryProperties(accountId)}),$("#propertyId").on("change",function(){propertyId=$(this).val(),queryProfiles(accountId,propertyId)}),$("#viewId").on("change",function(){viewId=$(this).val(),$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1)})});