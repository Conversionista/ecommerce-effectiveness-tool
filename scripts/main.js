"use strict";function apiResponse(e,t,n,a,o,s){$.when(queryShoppingStage(e,t,n,a,o),queryUsers(e,t,n,a,o),queryNonBounce(e,t,n,a,o)).then(function(e,t,n){for(var a=[],o=0,r=0;r<e.result.reports[0].data.rows.length;r++){var i=e.result.reports[0].data.rows[r].dimensions[0];console.log(i),jQuery.inArray(i,queryArray)>=0&&(queryObj[i]=e.result.reports[0].data.rows[r].metrics[0].values[0])}queryObj.USERS=0,$.each(t.result.reports[0].data.rows,function(e,t){queryObj.USERS+=Number(t.metrics[0].values[0])}),queryObj.NON_BOUNCE_USERS=0,$.each(n.result.reports[0].data.rows,function(e,t){queryObj.NON_BOUNCE_USERS+=Number(t.metrics[0].values[0])});var l=getPercent(queryObj.NON_BOUNCE_USERS,queryObj.USERS);if(checkIfNaN(l))return!1;a=[0,50,71],s?(o=getTrend(engagementResult,l),setComparison("engagement",l,o,a),$("#result-table").removeClass("hidden")):(engagementResult=l,setResult("engagement",l,a,queryObj.NON_BOUNCE_USERS));var c=getPercent(queryObj.PRODUCT_VIEW,queryObj.NON_BOUNCE_USERS);if(checkIfNaN(c))return!1;a=[0,60,81],s?(o=getTrend(findResult,c),setComparison("find",c,o,a)):(findResult=c,setResult("find",c,a,queryObj.PRODUCT_VIEW));var u=getPercent(queryObj.ADD_TO_CART,queryObj.PRODUCT_VIEW);if(checkIfNaN(u))return!1;a=[0,15,21],s?(o=getTrend(effectivenessResult,u),setComparison("effectiveness",u,o,a)):(effectivenessResult=u,setResult("effectiveness",u,a,queryObj.ADD_TO_CART));var p=getPercent(queryObj.CHECKOUT,queryObj.ADD_TO_CART);a=[0,60,81],s?(o=getTrend(beginCheckoutResult,p),setComparison("begin-checkout",p,o,a)):(beginCheckoutResult=p,setResult("begin-checkout",p,a,queryObj.CHECKOUT));var d=getPercent(queryObj.TRANSACTION,queryObj.CHECKOUT);a=[0,40,61],s?(o=getTrend(completeCheckoutResult,d),setComparison("complete-checkout",d,o,a)):(completeCheckoutResult=d,setResult("complete-checkout",d,a,queryObj.TRANSACTION));Math.round(100*(1-queryObj.TRANSACTION/queryObj.CHECKOUT));if($("#canvas").removeClass("hidden"),!s){var m=[["Stay on site",[queryObj.NON_BOUNCE_USERS,l]],["Finding product",[queryObj.PRODUCT_VIEW,c]],["Add to cart",[queryObj.ADD_TO_CART,u]],["Begin checkout",[queryObj.CHECKOUT,p]],["Complete checkout",[queryObj.TRANSACTION,d]]],g={chart:{width:"100%",height:350,bottomPinch:0,animate:100,curve:{enabled:!0,height:20}},block:{dynamicHeight:!1,highlight:!0,fill:{type:"gradient"}},label:{format:"{f}%"},events:{click:{block:function(e){0===e.index?swal({title:"Stay on site",text:'Engagement rate or opposite of bounce rate. Users who move on to another page or trigger some kind of event.<br><span style="color:green;">Good: 70-100%</span><br><span style="color:#E60000;">Bad: 0-50%</span>',html:!0}):1===e.index?swal({title:"Find products",text:'Finding rate, or how many users (out of the stay-on-site-users) who visit at least one product page.<br><span style="color:green;">Good: 80-100%</span><br><span style="color:#E60000;">Bad: 0-60%</span>',html:!0}):2===e.index?swal({title:"Add to cart",text:'Your product page effectiveness, or how many users (out of the find-product-users) who add an item to shopping cart.<br><span style="color:green;">Good: 20-100%</span><br><span style="color:#E60000;">Bad: 0-15%</span>',html:!0}):3===e.index?swal({title:"Begin checkout",text:'Checkout rate, or how many users (out of the add-to-cart-users) who visit the checkout page.<br><span style="color:green;">Good: 80-100%</span><br><span style="color:#E60000;">Bad: 0-50%</span>',html:!0}):4===e.index&&swal({title:"Complete checkout",text:'Checkout completion rate, or how many users (out of the begin-checkout-users) who complete the purchase.<br><span style="color:green;">Good: 60-100%</span><br><span style="color:#E60000;">Bad: 0-40%</span>',html:!0})}}}},h=new D3Funnel("#funnel");h.draw(m,g)}})}function queryUsers(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{viewId:e,dateRanges:[{startDate:t,endDate:n}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],dimensions:[{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}]}]}});return i}function queryNonBounce(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:n,startDate:t}],metrics:[{expression:"ga:users"}],samplingLevel:"LARGE",viewId:e,dimensions:[{name:"ga:segment"},{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}],segments:[{dynamicSegment:{name:"segment_name",sessionSegment:{segmentFilters:[{simpleSegment:{orFiltersForSegment:[{segmentFilterClauses:[{metricFilter:{metricName:"ga:bounces",operator:"EQUAL",comparisonValue:"0"}}]}]}}]}}}]}]}});return i}function queryShoppingStage(e,t,n,a,o){var s=[];"all"===a?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(a);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:n,startDate:t}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],viewId:e,dimensions:[{name:"ga:shoppingStage"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}]}]}});return i}function getPercent(e,t){var n=Math.round(e/t*100);return n}function getTrend(e,t){var n=Math.round(e-t);return n}function authorize(e){var t=!e,n={client_id:CLIENT_ID,scope:SCOPES,immediate:t};gapi.auth.authorize(n,function(e){var t=document.getElementById("auth-button");e.error?(t.hidden=!1,showAuthDialog()):(t.hidden=!0,console.log("inloggad"),queryAccounts())})}function showAuthDialog(){swal({title:"GA Authorization",html:!0,text:"We'll need permission to access your Google Analytics account.<br /> We won't save any infomation what so ever.",imageUrl:"images/google-analytics-logo.png",confirmButtonText:"Authorize",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),$(".authorize .confirm").click(function(e){$(this).html('<i class="fa fa-cog fa-spin"></i>').attr("disabled",!0),authorize(e)})}function queryAccounts(){gapi.client.load("analytics","v3").then(function(){gapi.client.analytics.management.accounts.list().then(handleAccounts)})}function handleAccounts(e){e.result.items&&e.result.items.length?($("#accountId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===accountId)var n=!0;else n=!1;$("#accountId").append($("<option/>",{value:t.id,text:t.name,selected:n}))}),accountId||(accountId=e.result.items[0].id),queryProperties(accountId)):console.log("No accounts found for this user.")}function queryProperties(e){gapi.client.analytics.management.webproperties.list({accountId:e}).then(handleProperties).then(null,function(e){console.log(e)})}function handleProperties(e){e.result.items&&e.result.items.length?($("#propertyId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){var n=null;n=t.id===propertyId,$("#propertyId").append($("<option/>",{value:t.id,text:t.name,selected:n}))}),propertyId||(propertyId=e.result.items[0].id),queryProfiles(accountId,propertyId)):console.log("No properties found for this user.")}function queryProfiles(e,t){gapi.client.analytics.management.profiles.list({accountId:e,webPropertyId:t}).then(handleProfiles).then(null,function(e){console.log(e)})}function handleProfiles(e){e.result.items&&e.result.items.length?($("#viewId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===viewId){var n=!0;$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1)}else n=!1;$("#viewId").append($("<option/>",{value:t.id,text:t.name,selected:n}))})):console.log("No views (profiles) found for this user.")}function saveLocal(e,t){localStorage.setItem(e,JSON.stringify(t))}function readLocal(e){var t=JSON.parse(localStorage.getItem(e));return t}function updateLocal(e,t,n){var a=readLocal(e);null===a&&(a={}),a[t]=n,saveLocal(e,a)}function setResult(e,t,n,a){var o=setBenchmarkSymbol(t,n);$("#"+e+"-result").addClass("").html(t+"%"+o),$("#"+e+"-users").addClass("").html(a),$("#th-comparison, #th-trend").addClass("hidden"),$("#"+e+"-comparison").removeClass("").addClass("hidden").html(""),$("#"+e+"-trend").removeClass("").addClass("hidden").html("")}function setComparison(e,t,n,a){var o=setBenchmarkSymbol(t,a),s=setTrendSymbol(n);$("#th-comparison, #th-trend").removeClass("hidden"),$("#"+e+"-comparison").removeClass("hidden").addClass("").html(t+"%"+o),$("#"+e+"-trend").removeClass("hidden").addClass("").html(n+"%"+s)}function setBenchmarkSymbol(e,t){var n=0;$.each(t,function(t,a){e>=a&&(n=t)});var a="";return 0===n?a='<span class="text-danger glyphicon glyphicon-exclamation-sign btn-xs" aria-hidden="true"></span>':1===n?a='<span class="text-warning glyphicon glyphicon-eye-open btn-xs" aria-hidden="true"></span>':2===n&&(a='<span class="text-success glyphicon glyphicon-ok btn-xs" aria-hidden="true"></span>'),a}function setTrendSymbol(e){var t="";return 0===e?t='<span class="invisible glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e>0?t='<span class="text-success glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e<0&&(t='<span class="text-danger glyphicon glyphicon-triangle-bottom btn-xs" aria-hidden="true"></span>'),t}function checkIfNaN(e){var t=!1;return isNaN(e)&&(swal({title:"Oops!",html:!0,text:"It seems your website doesn't use ecommerce tracking.<br>Please contact us for help!",imageUrl:"images/google-analytics-logo.png",confirmButtonText:"OK :(",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),t=!0),t}var ecomFunnel=readLocal("ecomFunnel");if(null!==ecomFunnel)var accountId=ecomFunnel.accountId,propertyId=ecomFunnel.propertyId,viewId=ecomFunnel.viewId;else accountId=!1,propertyId=!1,viewId=!1;var queryArray=["PRODUCT_VIEW","ADD_TO_CART","CHECKOUT","TRANSACTION"],queryObj={},CLIENT_ID="856128908931-99pe52krvhcn0v81oie89b357gqvgamq.apps.googleusercontent.com",SCOPES=["https://www.googleapis.com/auth/analytics.readonly","https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/plus.profile.emails.read"],startDate=moment().subtract(31,"days").format("YYYY-MM-DD"),endDate=moment().subtract(1,"days").format("YYYY-MM-DD"),deviceCategory="",userType="",engagementResult=0,findResult=0,effectivenessResult=0,beginCheckoutResult=0,completeCheckoutResult=0;$(document).ready(function(){$('input[name="daterange"]').daterangepicker({locale:{format:"YYYY-MM-DD",separator:" – ",applyLabel:"Apply",cancelLabel:"Undo",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"w. ",daysOfWeek:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],firstDay:1},showISOWeekNumbers:!0,applyClass:"btn btn-success",cancelClass:"btn btn-danger",startDate:startDate,endDate:endDate}),$("#date-range").on("apply.daterangepicker",function(e,t){startDate=t.startDate.format("YYYY-MM-DD"),endDate=t.endDate.format("YYYY-MM-DD"),$("#date-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD"))}),$("#comparison-range").on("apply.daterangepicker",function(e,t){var n=t.startDate.format("YYYY-MM-DD"),a=t.endDate.format("YYYY-MM-DD");$("#comparison-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD")),apiResponse(viewId,n,a,deviceCategory,userType,!0)}),$("#date-range").val(startDate+" to "+endDate),$("#comparison-range").val(""),$("#save-settings-btn").on("click",function(e){e.preventDefault(),updateLocal("ecomFunnel","accountId",accountId),updateLocal("ecomFunnel","propertyId",propertyId),updateLocal("ecomFunnel","viewId",viewId)}),$("#get-funnel-btn").on("click",function(e){e.preventDefault(),deviceCategory=$('input[name="deviceCategory"]:checked').val(),userType=$('input[name="userType"]:checked').val(),apiResponse(viewId,startDate,endDate,deviceCategory,userType)}),$("#accountId").on("change",function(){accountId=$(this).val(),queryProperties(accountId)}),$("#propertyId").on("change",function(){propertyId=$(this).val(),queryProfiles(accountId,propertyId)}),$("#viewId").on("change",function(){viewId=$(this).val(),$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1)})});