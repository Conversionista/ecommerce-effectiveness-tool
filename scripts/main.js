"use strict";function apiResponse(e,t,a,n,o,s){showLoader();var r=loaderTick(2,100,150);$.when(queryShoppingStage(e,t,a,n,o),queryUsers(e,t,a,n,o),queryNonBounce(e,t,a,n,o)).then(function(e,t,a){var n=0;void 0!==e.result.reports[0].data.rows&&(n=e.result.reports[0].data.rows.length);for(var o=0,i=0;i<n;i++){var l=e.result.reports[0].data.rows[i].dimensions[0];jQuery.inArray(l,queryArray)>=0&&(queryObj[l]=e.result.reports[0].data.rows[i].metrics[0].values[0])}queryObj.USERS=0,console.log("Users (bounce & non bounce)"),$.each(t.result.reports[0].data.rows,function(e,t){queryObj.USERS+=Number(t.metrics[0].values[0]);var a="";0===e?a="New users on desktop":1===e?a="New users on mobile":2===e?a="New users on tablet":3===e?a="Returning users on desktop":4===e?a="Returning users on mobile":5===e&&(a="Returning users on tablet"),console.log(a+": "+Number(t.metrics[0].values[0]))}),console.log("Total users: "+queryObj.USERS),s?($("#all-comparison").removeClass("hidden").html(queryObj.USERS),$("#all-trend").removeClass("hidden").html("-")):($("#all-users").addClass("").html(queryObj.USERS),$("#all-result").html("-"),$("#all-comparison").addClass("hidden").html(""),$("#all-trend").addClass("hidden").html("")),queryObj.NON_BOUNCE_USERS=0,console.log("Users (non bounce)"),$.each(a.result.reports[0].data.rows,function(e,t){queryObj.NON_BOUNCE_USERS+=Number(t.metrics[0].values[0]);var a="";0===e?a="New users on desktop":1===e?a="New users on mobile":2===e?a="New users on tablet":3===e?a="Returning users on desktop":4===e?a="Returning users on mobile":5===e&&(a="Returning users on tablet"),console.log(a+": "+Number(t.metrics[0].values[0]))});var c=getPercent(queryObj.NON_BOUNCE_USERS,queryObj.USERS);if(checkIfNaN(c))return!1;console.log("Total non bounce users: "+queryObj.NON_BOUNCE_USERS);var u=[0,50,71];s?(o=getTrend(engagementResult,c),setComparison("engagement",c,o,u),$("#result-table").removeClass("hidden")):(engagementResult=c,setResult("engagement",c,u,queryObj.NON_BOUNCE_USERS),$("#result-table").removeClass("hidden"));var d=getPercent(queryObj.PRODUCT_VIEW,queryObj.NON_BOUNCE_USERS);if(console.log(d),checkIfNaN(d))return!1;var p=[0,60,81];s?(o=getTrend(findResult,d),setComparison("find",d,o,p)):(findResult=d,setResult("find",d,p,queryObj.PRODUCT_VIEW));var m=getPercent(queryObj.ADD_TO_CART,queryObj.PRODUCT_VIEW);if(checkIfNaN(m))return!1;var g=[0,15,21];s?(o=getTrend(effectivenessResult,m),setComparison("effectiveness",m,o,g)):(effectivenessResult=m,setResult("effectiveness",m,g,queryObj.ADD_TO_CART));var h=getPercent(queryObj.CHECKOUT,queryObj.ADD_TO_CART),b=[0,60,81];s?(o=getTrend(beginCheckoutResult,h),setComparison("begin-checkout",h,o,b)):(beginCheckoutResult=h,setResult("begin-checkout",h,b,queryObj.CHECKOUT));var f=getPercent(queryObj.TRANSACTION,queryObj.CHECKOUT),y=[0,40,61];if(s?(o=getTrend(completeCheckoutResult,f),setComparison("complete-checkout",f,o,y)):(completeCheckoutResult=f,setResult("complete-checkout",f,y,queryObj.TRANSACTION)),$("#canvas").removeClass("hidden"),$("#click-blocks").removeClass("hidden"),!s){var v=[["Stay on site",c,setBenchmarkColor(c,u)],["Finding product",d,setBenchmarkColor(d,p)],["Add to cart",m,setBenchmarkColor(m,g)],["Begin checkout",h,setBenchmarkColor(h,b)],["Complete checkout",f,setBenchmarkColor(f,y)]];console.log(v);var C={chart:{width:"100%",height:350,bottomPinch:0,animate:100,curve:{enabled:!0,height:20}},block:{dynamicHeight:!1,highlight:!0,barOverlay:!1,fill:{type:"gradient"}},label:{format:"{f}%"},events:{click:{block:function(e){0===e.index?swal({title:"Stay on site",text:'Is calculated based on <i>Engagement rate</i> (opposite of bounce rate). Meaning, users who interacted with your site by visiting more than one page or triggered some kind of interaction event.<br><br><span style="color:green;"><b>Good: 70-100%</b></span><br><span style="color:#ffc933;"><b>OK: 50-70%</b></span><br><span style="color:#c61618;"><b>Bad: 0-50%</b></span>',html:!0}):1===e.index?swal({title:"Find products",text:'Is calculated based on <i>Finding rate</i>. Meaning, how many users (out of the stay-on-site-users) who visited at least one product page.<br><br><span style="color:green;"><b>Good: 80-100%</b></span><br><span style="color:#ffc933;"><b>OK: 60-80%</b></span><br><span style="color:#c61618;"><b>Bad: 0-60%</b></span>',html:!0}):2===e.index?swal({title:"Add to cart",text:'Is calculated based on <i>Product page effectiveness rate</i>. Meaning, how many users (out of the find-products-users) who added an item to the shopping cart.<br><br><span style="color:green;"><b>Good: 20-100%</b></span><br><span style="color:#ffc933;"><b>OK: 15-20%</b></span><br><span style="color:#c61618;"><b>Bad: 0-15%</b></span>',html:!0}):3===e.index?swal({title:"Begin checkout",text:'Is calculated based on <i>Checkout rate</i>. Meaning, how many users (out of the add-to-cart-users) who proceeded to visit the checkout page.<br><br><span style="color:green;"><b>Good: 80-100%</b></span><br><span style="color:#ffc933;"><b>OK: 60-80%</b></span><br><span style="color:#c61618;"><b>Bad: 0-60%</b></span>',html:!0}):4===e.index&&swal({title:"Complete checkout",text:'Is calculated based on <i>Checkout completion rate</i>. Meaning, how many users (out of the begin-checkout-users) who completed their purchase.<br><br><span style="color:green;"><b>Good: 60-100%</b></span><br><span style="color:#ffc933;"><b>OK: 40-60%</b></span><br><span style="color:#c61618;"><b>Bad: 0-40%</b></span>',html:!0})}}}},D=new D3Funnel("#funnel");D.draw(v,C)}clearInterval(r),setProgressBar(100),hideLoader()})}function queryUsers(e,t,a,n,o){var s=[];"all"===n?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(n);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{viewId:e,dateRanges:[{startDate:t,endDate:a}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],dimensions:[{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}]}]}});return i}function queryNonBounce(e,t,a,n,o){var s=[];"all"===n?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(n);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:a,startDate:t}],metrics:[{expression:"ga:users"}],samplingLevel:"LARGE",viewId:e,dimensions:[{name:"ga:segment"},{name:"ga:userType"},{name:"ga:deviceCategory"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}],segments:[{dynamicSegment:{name:"non_bounces",sessionSegment:{segmentFilters:[{simpleSegment:{orFiltersForSegment:[{segmentFilterClauses:[{metricFilter:{metricName:"ga:bounces",operator:"EQUAL",comparisonValue:"0"}}]}]}}]}}}]}]}});return i}function queryShoppingStage(e,t,a,n,o){var s=[];"all"===n?(s.push("desktop"),s.push("tablet"),s.push("mobile")):s.push(n);var r=[];"all"===o?(r.push("New Visitor"),r.push("Returning Visitor")):r.push(o);var i=gapi.client.request({path:"/v4/reports:batchGet",root:"https://analyticsreporting.googleapis.com/",method:"POST",body:{reportRequests:[{dateRanges:[{endDate:a,startDate:t}],samplingLevel:"LARGE",metrics:[{expression:"ga:users"}],viewId:e,dimensions:[{name:"ga:shoppingStage"},{name:"ga:segment"}],dimensionFilterClauses:[{operator:"AND",filters:[{dimensionName:"ga:userType",operator:"IN_LIST",expressions:r},{dimensionName:"ga:deviceCategory",operator:"IN_LIST",expressions:s}]}],segments:[{dynamicSegment:{name:"non_bounces",sessionSegment:{segmentFilters:[{simpleSegment:{orFiltersForSegment:[{segmentFilterClauses:[{metricFilter:{metricName:"ga:bounces",operator:"EQUAL",comparisonValue:"0"}}]}]}}]}}}]}]}});return i}function getPercent(e,t){var a=Math.round(e/t*100);return a}function getTrend(e,t){var a=Math.round(e-t);return a}function authorize(e){var t=!e,a={client_id:CLIENT_ID,scope:SCOPES,immediate:t};gapi.auth.authorize(a,function(e){var t=document.getElementById("auth-button");e.error?(t.hidden=!1,showAuthDialog()):(t.hidden=!0,console.log("inloggad"),null===ecomFunnel&&$("#modalSettings").modal("show"),queryAccounts())})}function showAuthDialog(){swal({title:"GA Authorization",html:!0,text:"We'll need permission to access your Google Analytics account.<br />",imageUrl:"images/google-analytics-logo.png",confirmButtonText:"Authorize",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),$(".authorize .confirm").click(function(e){$(this).html('<i class="fa fa-cog fa-spin"></i>').attr("disabled",!0),authorize(e)})}function queryAccounts(){gapi.client.load("analytics","v3").then(function(){gapi.client.analytics.management.accounts.list().then(handleAccounts)}),gapi.client.load("plus","v1",function(){var e=gapi.client.plus.people.get({userId:"me"});e.execute(function(e){var t=e.displayName,a=handleEmailResponse(e);sendUserData(t,a),console.log("Retrieved profile for:"+t+", "+a)})})}function handleEmailResponse(e){for(var t,a=0;a<e.emails.length;a++)"account"===e.emails[a].type&&(t=e.emails[a].value);return t}function sendUserData(e,t){"undefined"!=typeof analytics&&(console.log(e+"\n"+t),analytics.identify({name:e,email:t}))}function handleAccounts(e){e.result.items&&e.result.items.length?($("#accountId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===accountId)var a=!0;else a=!1;$("#accountId").append($("<option/>",{value:t.id,text:t.name,selected:a}))}),accountId||(accountId=e.result.items[0].id),queryProperties(accountId)):console.log("No accounts found for this user.")}function queryProperties(e){gapi.client.analytics.management.webproperties.list({accountId:e}).then(handleProperties).then(null,function(e){console.log(e)})}function handleProperties(e){e.result.items&&e.result.items.length?($("#propertyId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){var a=null;a=t.id===propertyId,$("#propertyId").append($("<option/>",{value:t.id,text:t.name,selected:a}))}),propertyId||(propertyId=e.result.items[0].id),queryProfiles(accountId,propertyId)):console.log("No properties found for this user.")}function queryProfiles(e,t){gapi.client.analytics.management.profiles.list({accountId:e,webPropertyId:t}).then(handleProfiles).then(null,function(e){console.log(e)})}function handleProfiles(e){e.result.items&&e.result.items.length?($("#viewId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1),$.each(e.result.items,function(e,t){if(t.id===viewId){var a=!0;$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1),$("#selected-account").text(t.name)}else a=!1;$("#viewId").append($("<option/>",{value:t.id,text:t.name,selected:a}))})):console.log("No views (profiles) found for this user.")}function saveLocal(e,t){localStorage.setItem(e,JSON.stringify(t))}function readLocal(e){var t=JSON.parse(localStorage.getItem(e));return t}function updateLocal(e,t,a){var n=readLocal(e);null===n&&(n={}),n[t]=a,saveLocal(e,n)}function setResult(e,t,a,n){var o=setBenchmarkSymbol(t,a);$("#"+e+"-result").addClass("").html(t+"%"+o),$("#"+e+"-users").addClass("").html(n),$("#th-comparison, #th-trend").addClass("hidden"),$("#"+e+"-comparison").removeClass("").addClass("hidden").html(""),$("#"+e+"-trend").removeClass("").addClass("hidden").html("")}function setComparison(e,t,a,n){var o=setBenchmarkSymbol(t,n),s=setTrendSymbol(a);$("#th-comparison, #th-trend").removeClass("hidden"),$("#"+e+"-comparison").removeClass("hidden").addClass("").html(t+"%"+o),$("#"+e+"-trend").removeClass("hidden").addClass("").html(a+"%"+s)}function setBenchmarkColor(e,t){var a=0;$.each(t,function(t,n){e>=n&&(a=t)});var n="";return 0===a?n="#C12107":1===a?n="#F4CD24":2===a&&(n="#65B739"),n}function setBenchmarkSymbol(e,t){var a=0;$.each(t,function(t,n){e>=n&&(a=t)});var n="";return 0===a?n='<span class="text-danger glyphicon glyphicon-exclamation-sign btn-xs" aria-hidden="true"></span>':1===a?n='<span class="text-warning glyphicon glyphicon-eye-open btn-xs" aria-hidden="true"></span>':2===a&&(n='<span class="text-success glyphicon glyphicon-ok btn-xs" aria-hidden="true"></span>'),n}function setTrendSymbol(e){var t="";return 0===e?t='<span class="invisible glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e>0?t='<span class="text-success glyphicon glyphicon-triangle-top btn-xs" aria-hidden="true"></span>':e<0&&(t='<span class="text-danger glyphicon glyphicon-triangle-bottom btn-xs" aria-hidden="true"></span>'),t}function checkIfNaN(e){var t=!1;return isNaN(e)&&(setProgressBar(100),hideLoader(),swal({title:"Oops!",html:!0,text:'It seems your website doesn\'t have enhanced ecommerce tracking in place.<br><a href="mailto:martin@conversionista.se">Please contact us for help!</a>',imageUrl:"images/google-analytics-logo.png",confirmButtonText:"OK :(",confirmButtonColor:"#5cb85c",customClass:"authorize",showCancelButton:!1}),t=!0),t}function hideLoader(){$("#loader").fadeOut(200)}function showLoader(){$("#loader").fadeIn(200)}function setProgressBar(e){$("body").removeClass("pace-done").addClass("pace-running"),$(".pace").removeClass("pace-inactive").addClass("pace-active"),$(".pace-progress").attr("data-progress-text",e+"%").attr("style","transform: translate3d("+e+"%, 0px, 0px);"),100===e&&($("body").removeClass("pace-running").addClass("pace-done"),$(".pace").removeClass("pace-active").addClass("pace-inactive"))}function loaderTick(e,t,a){var n=e,o=setInterval(function(){n<=t&&($(".pace-progress").attr("data-progress-text",n+"%").attr("style","transform: translate3d("+n+"%, 0px, 0px);"),n++)},a);return o}var ecomFunnel=readLocal("ecomFunnel");if(null!==ecomFunnel){var accountId=ecomFunnel.accountId,propertyId=ecomFunnel.propertyId,viewId=ecomFunnel.viewId;console.log(viewId)}else accountId=!1,propertyId=!1,viewId=!1;var queryArray=["PRODUCT_VIEW","ADD_TO_CART","CHECKOUT","TRANSACTION"],queryObj={},CLIENT_ID="856128908931-99pe52krvhcn0v81oie89b357gqvgamq.apps.googleusercontent.com",SCOPES=["https://www.googleapis.com/auth/analytics.readonly","https://www.googleapis.com/auth/plus.me","https://www.googleapis.com/auth/plus.profile.emails.read"],startDate=moment().subtract(31,"days").format("YYYY-MM-DD"),endDate=moment().subtract(1,"days").format("YYYY-MM-DD"),comparisonStartDate=0,comparisonEndDate=0,deviceCategory="",userType="",engagementResult=0,findResult=0,effectivenessResult=0,beginCheckoutResult=0,completeCheckoutResult=0;$(document).ready(function(){Pace.on("done",function(){hideLoader()}),$('input[name="daterange"]').daterangepicker({locale:{format:"YYYY-MM-DD",separator:" – ",applyLabel:"Apply",cancelLabel:"Cancel",fromLabel:"From",toLabel:"To",customRangeLabel:"Custom",weekLabel:"w. ",daysOfWeek:["Su","Mo","Tu","We","Th","Fr","Sa"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],firstDay:1},showISOWeekNumbers:!0,applyClass:"btn btn-success",cancelClass:"btn btn-danger",startDate:startDate,endDate:endDate}),$("#date-range").on("apply.daterangepicker",function(e,t){startDate=t.startDate.format("YYYY-MM-DD"),endDate=t.endDate.format("YYYY-MM-DD"),$("#date-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD"))}),$("#date-range").on("cancel.daterangepicker",function(){$("#date-range").val(startDate+" to "+endDate)}),$("#comparison-range").on("apply.daterangepicker",function(e,t){comparisonStartDate=t.startDate.format("YYYY-MM-DD"),comparisonEndDate=t.endDate.format("YYYY-MM-DD"),$("#comparison-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD"))}),$("#comparison-range").on("hide.daterangepicker",function(e,t){0===comparisonStartDate&&0===comparisonEndDate?$("#comparison-range").val(""):$("#comparison-range").val(t.startDate.format("YYYY-MM-DD")+" to "+t.endDate.format("YYYY-MM-DD"))}),$("#comparison-range").on("cancel.daterangepicker",function(){comparisonStartDate=0,comparisonEndDate=0,$("#comparison-range").val("")}),$("#date-range").val(startDate+" to "+endDate),$("#comparison-range").val(""),$("#save-settings-btn").on("click",function(e){e.preventDefault(),updateLocal("ecomFunnel","accountId",accountId),updateLocal("ecomFunnel","propertyId",propertyId),updateLocal("ecomFunnel","viewId",viewId)}),$("#get-funnel-btn").on("click",function(e){e.preventDefault(),setProgressBar(0),deviceCategory=$('input[name="deviceCategory"]:checked').val(),userType=$('input[name="userType"]:checked').val(),$.when(apiResponse(viewId,startDate,endDate,deviceCategory,userType)).then(function(){0!==comparisonStartDate&&0!==comparisonEndDate&&apiResponse(viewId,comparisonStartDate,comparisonEndDate,deviceCategory,userType,!0),$("#get-funnel-btn").text("Update result")})}),$("#accountId").on("change",function(){accountId=$(this).val(),queryProperties(accountId),$("#viewId").html('<option selected="selected" disabled="true">-- Please select -- </option>').attr("disabled",!1)}),$("#propertyId").on("change",function(){propertyId=$(this).val(),queryProfiles(accountId,propertyId)}),$("#viewId").on("change",function(){viewId=$(this).val();var e=$("#viewId option:selected").text();$("#get-funnel-btn").prop("disabled",!1),$("#save-settings-btn").prop("disabled",!1),$("#selected-account").text(e)}),$("#comparison-toggle").click(function(e){e.preventDefault(),$("#comparison-date").slideToggle(200,function(){$("#comparison-toggle i").toggleClass("fa-angle-down").toggleClass("fa-angle-up")})})});